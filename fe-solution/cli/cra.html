<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>create-react-app 核心思路分析 | 玩相机的程序员</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="代码和照片本质都是创造，是一种信息的传递。我是玩相机的程序员 axuebin，用键盘和相机记录和分享。">
    <link rel="preload" href="/articles/assets/css/0.styles.fe65aa1c.css" as="style"><link rel="preload" href="/articles/assets/js/app.310f691c.js" as="script"><link rel="preload" href="/articles/assets/js/2.8d419c10.js" as="script"><link rel="preload" href="/articles/assets/js/19.60c3b1e2.js" as="script"><link rel="preload" href="/articles/assets/js/3.97f21fa0.js" as="script"><link rel="preload" href="/articles/assets/js/4.3f1e58e8.js" as="script"><link rel="prefetch" href="/articles/assets/js/10.4265f4ce.js"><link rel="prefetch" href="/articles/assets/js/11.76f5f86d.js"><link rel="prefetch" href="/articles/assets/js/12.893e4bb1.js"><link rel="prefetch" href="/articles/assets/js/13.98208f64.js"><link rel="prefetch" href="/articles/assets/js/14.7a017fd2.js"><link rel="prefetch" href="/articles/assets/js/15.3426649e.js"><link rel="prefetch" href="/articles/assets/js/16.4e7dfcad.js"><link rel="prefetch" href="/articles/assets/js/17.ceed3886.js"><link rel="prefetch" href="/articles/assets/js/18.288adc60.js"><link rel="prefetch" href="/articles/assets/js/20.9438fdb5.js"><link rel="prefetch" href="/articles/assets/js/21.35e5c2c6.js"><link rel="prefetch" href="/articles/assets/js/22.8f5f945f.js"><link rel="prefetch" href="/articles/assets/js/5.5f71be51.js"><link rel="prefetch" href="/articles/assets/js/6.f64c5fbd.js"><link rel="prefetch" href="/articles/assets/js/7.47f2d43a.js"><link rel="prefetch" href="/articles/assets/js/8.22fa8963.js"><link rel="prefetch" href="/articles/assets/js/9.16d00e35.js">
    <link rel="stylesheet" href="/articles/assets/css/0.styles.fe65aa1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/articles/" class="router-link-active home-link"><img src="/articles/assets/img/avatar.jpg" alt="玩相机的程序员" class="logo"> <span class="site-name">玩相机的程序员</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-solution/" class="router-link-active">
          前端工程化
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-interview/">
          前端面试
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          关注我
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <!----></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="ads"><div id="ads_2"><div class="ant-carousel"><div class="slick-slider slick-initialized"><div class="slick-list"><div class="slick-track"><div tabIndex="-1" data-index="0" class="slick-slide slick-active slick-current" style="outline:none;width:null;"><div><div tabIndex="-1" style="width:100%;display:inline-block;"><a target="_blank" rel="noopener noreferrer"><img src="/articles/assets/img/qrcode2.jpg" title="Ads details here"></a></div></div></div></div></div></div></div></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>脚手架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/cli/desc.html" title="现代 CLI 和 GUI 方案指南" class="sidebar-link">现代 CLI 和 GUI 方案指南</a></li><li><a href="/articles/fe-solution/cli/cra.html" aria-current="page" title="create-react-app 核心思路分析" class="active sidebar-link">create-react-app 核心思路分析</a></li><li><a href="/articles/fe-solution/cli/vuecli.html" title="Vue CLI 是如何实现的 -- 终端命令行工具篇" class="sidebar-link">Vue CLI 是如何实现的 -- 终端命令行工具篇</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Babel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/babel/first.html" title="初学 Babel 工作原理" class="sidebar-link">初学 Babel 工作原理</a></li><li><a href="/articles/fe-solution/babel/auto-require.html" title="如何用 Babel 为代码自动引入依赖" class="sidebar-link">如何用 Babel 为代码自动引入依赖</a></li><li><a href="/articles/fe-solution/babel/babel-plugin-import.html" title="简单实现 babel-plugin-import 插件" class="sidebar-link">简单实现 babel-plugin-import 插件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>构建相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/build/rax-analysis.html" title="当我谈 Rax 按端拆分代码的时候我谈些什么" class="sidebar-link">当我谈 Rax 按端拆分代码的时候我谈些什么</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码规范相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/lint/eslint.html" title="中小型前端团队代码规范工程化最佳实践 - ESLint" class="sidebar-link">中小型前端团队代码规范工程化最佳实践 - ESLint</a></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="create-react-app-核心思路分析"><a href="#create-react-app-核心思路分析" class="header-anchor">#</a> create-react-app 核心思路分析</h1> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3bca848b5f104a34a083a7de996feb96~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <blockquote><p>Create React App is an officially supported way to create single-page React applications. It offers a modern build setup with no configuration.</p></blockquote> <p><code>create react app</code> 是 <code>React</code> 官方创建单页应用的方式，为了方便，下文皆简称 <code>CRA</code>。</p> <p>它的核心思想我理解主要是：</p> <ol><li><strong>脚手架核心功能中心化</strong>：使用 <code>npx</code> 保证每次用户使用的都是最新版本，方便功能的升级</li> <li><strong>模板去中心化</strong>：方便地进行模板管理，这样也允许用户自定义模板</li> <li><strong>脚手架逻辑和初始化代码逻辑分离</strong>：在 <code>cra</code> 中只执行了脚手架相关逻辑，而初始化代码的逻辑在 <code>react-scripts</code> 包里执行</li></ol> <p>本文主要就是通过源码分析对上述的理解进行阐述。</p> <p>按照自己的理解，画了个流程图，大家可以带着该流程图去阅读源码（主要包含两个部分 <code>create-react-app</code> 和 <code>react-scripts/init</code>）：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c863a4cc49e04473bec8aa452722d1bb~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>如果图片不清晰可以微信搜索公众号 <strong>玩相机的程序员</strong>，回复 <code>CRA</code> 获取。</p> <h2 id="_0-用法"><a href="#_0-用法" class="header-anchor">#</a> 0. 用法</h2> <p><code>CRA</code> 的用法很简单，两步：</p> <ol><li>安装：<code>npm install -g create-react-app</code></li> <li>使用：<code>create-react-app my-app</code></li></ol> <p>这是常见的用法，会在全局环境下安装一个 <code>CRA</code>，在命令行中可以通过 <code>create react app</code> 直接使用。</p> <p>现在更推荐的用法是使用 <code>npx</code> 来执行 <code>create react app</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>npx create-react-app my-app
</code></pre></div><p>这样确保每次执行 <code>create-reat-app</code> 使用的都是 <code>npm</code> 上最新的版本。</p> <p>注：<a href="https://gist.github.com/gaearon/4064d3c23a77c74a3614c498a8bb1c5f" title="npx" target="_blank" rel="noopener noreferrer">npx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 <code>npm 5.2+</code> 之后引入的功能，如需使用需要 <code>check</code> 一下本地的 <code>npm</code> 版本。</p> <p>默认情况下，<code>CRA</code> 命令只需要传入 <code>project-directory</code> 即可，不需要额外的参数，更多用法查看：<a href="https://create-react-app.dev/docs/getting-started#creating-an-app" title="https://create-react-app.dev/docs/getting-started#creating-an-app" target="_blank" rel="noopener noreferrer">https://create-react-app.dev/docs/getting-started#creating-an-app<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，就不展开了。</p> <p>可以看一下官方的 Demo 感受一下：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bbac24f5e23e444384ebf6fcefe35958~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>我们主要还是通过 <code>CRA</code> 的源码来了解一下它的思路。</p> <h2 id="_1-入口"><a href="#_1-入口" class="header-anchor">#</a> 1. 入口</h2> <blockquote><p>本文中的 <code>create-react-app</code> 版本为 <code>4.0.1</code>。若阅读本文时存在 <code>break change</code>，可能就需要自己理解一下啦</p></blockquote> <p>按照正常逻辑，我们在 <code>package.json</code> 里找到了入口文件：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;create-react-app&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./index.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>index.js</code> 里的逻辑比较简单，判断了一下 <code>node</code> 环境是否是 <code>10</code> 以上，就调用 <code>init</code> 了，所以核心还是在 <code>init</code> 方法里。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./createReactApp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>打开 <code>createReactApp.js</code> 文件一看，好家伙，<strong>1017</strong> 行代码（别慌，跟着我往下看，<strong>1000</strong> 行代码也分分钟看明白）</p> <p><s>吐槽一下，虽然代码逻辑写得很清楚，但是为啥不拆几个模块呢？</s></p> <p>找到 <code>init</code> 方法之后发现，其实就执行了一个 <code>Promise</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// createReactApp.js</span>
<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">checkForLatestVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意这里是先 <code>catch</code> 再 <code>then</code>。</p> <p>跟着我往下看呗 ~ 一步一步理清楚 <code>CRA</code>，你也能依葫芦画瓢造一个。</p> <h2 id="_2-检查版本"><a href="#_2-检查版本" class="header-anchor">#</a> 2. 检查版本</h2> <p><code>checkForLatestVersion</code> 就做了一件事，获取 <code>create-react-app</code> 这个 <code>npm</code> 包的 <code>latest</code> 版本号。</p> <p>如果你想获取某个 <code>npm</code> 包的版本号，可以通过开放接口 <code>[https://registry.npmjs.org/-/package/{pkgName}/dist-tags](https://registry.npmjs.org/-/package/%7BpkgName%7D/dist-tags &quot;https://registry.npmjs.org/-/package/{pkgName}/dist-tags&quot;)</code> 获得，其返回值为：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;next&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.0.0-next.117&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;latest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;canary&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.3.0-next.38&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果你想获取某个 <code>npm</code> 包完整信息，可以通过开放接口 <code>[https://registry.npmjs.org/{pkgName}](https://registry.npmjs.org/%7BpkgName%7D &quot;https://registry.npmjs.org/{pkgName}&quot;)</code> 获得，其返回值为：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;create-react-app&quot;</span><span class="token punctuation">,</span>       # 包名
  <span class="token property">&quot;dist-tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                  # 版本语义化标签
  <span class="token property">&quot;versions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                   # 所有版本信息
  <span class="token property">&quot;readme&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>                     # README 内容（markdown 文本）
  <span class="token property">&quot;maintainers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;time&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                       # 每个版本的发布时间
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;readmeFilename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;README.md&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;homepage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>                   # 主页
  <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                   # 关键词
  <span class="token property">&quot;repository&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                 # 代码仓库
  <span class="token property">&quot;bugs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                       # 提 bug 链接
  <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>回到源码，<code>checkForLatestVersion().catch().then()</code>，注意这里是先 <code>catch</code> 再 <code>then</code>，也就是说如果 <code>checkForLatestVersion</code> 里抛错误了，会被 <code>catch</code> 住，然后执行一些逻辑，再执行 <code>then</code>。</p> <p>是的，<code>Promise</code> 的 <code>catch</code> 后面的 <code>then</code> 还是会执行。</p> <h3 id="_2-1-promise-catch-后的-then"><a href="#_2-1-promise-catch-后的-then" class="header-anchor">#</a> 2.1 Promise catch 后的 then</h3> <p>我们可以做个小实验：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Promise 失败了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise 失败了</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ErrorMessage: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ErrorMessage: Promise 失败了</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>原理也很简单，<code>then</code> 和 <code>catch</code> 返回的都是一个 <code>promise</code>，当然可以继续调用。</p> <p>OK，<code>checkForLatestVersion</code> 以及之后的 <code>catch</code> 都是只做了一件事，获取 <code>latest</code> 版本号，如果没有就是 <code>null</code>。</p> <p>这里拿到版本号之后也就判断一下当前使用的版本是否比 <code>latest</code> 版本低，如果是就推荐你把全局的 <code>CRA</code> 删了，使用 <code>npx</code> 来执行 <code>CRA</code>。</p> <h2 id="_3-核心方法-createapp"><a href="#_3-核心方法-createapp" class="header-anchor">#</a> 3. 核心方法 createApp</h2> <p>再往下看就是执行了一个 <code>createApp</code> 了，看这名字就知道最关键的方法就是它了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> version<span class="token punctuation">,</span> template<span class="token punctuation">,</span> useNpm<span class="token punctuation">,</span> usePnp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 此处省略 100 行代码</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createApp</code> 传入了 6 个参数，对应的是 <code>CRA</code> 命令行传入的一些配置。</p> <p>我在思考为啥这里不设计成一个 <code>options</code> 对象来接受这些参数？如果后期需要增删一些参数，是不是比较不好维护？这样的想法是我过度设计吗？</p> <h2 id="_4-检查应用名"><a href="#_4-检查应用名" class="header-anchor">#</a> 4. 检查应用名</h2> <p><code>CRA</code> 会检查输入的 <code>project name</code> 是否符合以下两条规范：</p> <ul><li>检查是否符合 <code>npm</code> 命名规范</li> <li>检查是否含有 <code>react</code>/<code>react-dom</code>/<code>react-scripts</code> 等关键字
不符合规范则直接 <code>process.exit(1)</code> 退出进程。</li></ul> <h2 id="_5-创建-package-json"><a href="#_5-创建-package-json" class="header-anchor">#</a> 5. 创建 package.json</h2> <p>和一般脚手架不同的是，<code>CRA</code> 会在创建项目时新创建一个 <code>package.json</code>，而不是直接复制代码模板的文件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> appName<span class="token punctuation">,</span>
  version<span class="token operator">:</span> <span class="token string">'0.1.0'</span><span class="token punctuation">,</span>
  <span class="token keyword">private</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>packageJson<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> os<span class="token punctuation">.</span><span class="token constant">EOL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_6-选择模板"><a href="#_6-选择模板" class="header-anchor">#</a> 6. 选择模板</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getTemplateInstallPackage</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> originalDirectory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> templateToInstall <span class="token operator">=</span> <span class="token string">'cra-template'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一些处理逻辑 doTemplate(template);</span>
    templateToInstall <span class="token operator">=</span> <span class="token function">doTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>templateToInstall<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>默认使用 <code>cra-template</code> 模板，如果传入 <code>template</code> 参数，则使用对用的模板，该方法主要是给额外的 <code>template</code> 加 <code>scope</code> 和 <code>prefix</code>，比如 <code>@scope/cra-template-${template}</code>，具体逻辑不展开。</p> <p>这里 <code>CRA</code>  的核心思想是通过 <code>npm</code> 来对模板进行管理，这样方便扩展和管理。</p> <h2 id="_7-安装依赖"><a href="#_7-安装依赖" class="header-anchor">#</a> 7. 安装依赖</h2> <p><code>CRA</code> 会自动给项目安装 <code>react</code>、<code>react-dom</code> 和 <code>react-scripts</code> 以及模板。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>command <span class="token operator">=</span> <span class="token string">'npm'</span><span class="token punctuation">;</span>
args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token string">'--save'</span><span class="token punctuation">,</span> <span class="token string">'--save-exact'</span><span class="token punctuation">,</span> <span class="token string">'--loglevel'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
  dependencies
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token string">'inherit'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-初始化代码"><a href="#_8-初始化代码" class="header-anchor">#</a> 8. 初始化代码</h2> <p><code>CRA</code> 的功能其实不多，安装完依赖之后，实际上初始化代码的工作还没做。</p> <p>接着往下看，看到这样一段代码代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> <span class="token function">executeNodeScript</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    cwd<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>root<span class="token punctuation">,</span> appName<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> originalDirectory<span class="token punctuation">,</span> templateName<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
var init = require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/scripts/init.js');
init.apply(null, JSON.parse(process.argv[1]));
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>除此之外，<code>CRA</code> 貌似看不到任何复制代码的代码了，那我们需要的“初始化代码”的工作应该就是在这里完成了。</p> <p>为了分析方便，忽略了上下文代码，说明一下，这段代码中的 <code>packageName</code> 的值是 <code>react-scripts</code>。也就是这里执行了 <code>react-scripts</code> 包中的 <code>scripts/init</code> 方法，并传入了几个参数。</p> <h3 id="_8-1-react-scripts-init-js"><a href="#_8-1-react-scripts-init-js" class="header-anchor">#</a> 8.1 react-scripts/init.js</h3> <p>老规矩，只分析主流程代码，主流程主要就做了四件事：</p> <ol><li>处理 <code>template</code> 里的 <code>packages.json</code></li> <li>处理 <code>package.json</code> 的 <code>scripts</code>：默认值和 <code>template</code> 合并</li> <li>写入 <code>package.json</code></li> <li>拷贝 <code>template</code> 文件</li></ol> <p>除此之外还有一些 <code>git</code> 和 <code>npm</code> 相关的操作，这里就不展开了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// init.js</span>
<span class="token comment">// 删除了不影响主流程的代码</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter">appPath<span class="token punctuation">,</span>
  appName<span class="token punctuation">,</span>
  verbose<span class="token punctuation">,</span>
  originalDirectory<span class="token punctuation">,</span>
  templateName</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> appPackage <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appPath<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 通过一些判断来处理 template 中的 package.json</span>
  <span class="token comment">// 返回 templatePackage</span>

  <span class="token keyword">const</span> templateScripts <span class="token operator">=</span> templatePackage<span class="token punctuation">.</span>scripts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 修改实际 package.json 中的 scripts</span>
  <span class="token comment">// start、build、test 和 eject 是默认的命令，如果模板里还有其它 script 就 merge</span>
  appPackage<span class="token punctuation">.</span>scripts <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token string">'react-scripts start'</span><span class="token punctuation">,</span>
      build<span class="token operator">:</span> <span class="token string">'react-scripts build'</span><span class="token punctuation">,</span>
      test<span class="token operator">:</span> <span class="token string">'react-scripts test'</span><span class="token punctuation">,</span>
      eject<span class="token operator">:</span> <span class="token string">'react-scripts eject'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    templateScripts
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 写 package.json</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>
    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appPath<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>appPackage<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> os<span class="token punctuation">.</span><span class="token constant">EOL</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 拷贝 template 文件</span>
  <span class="token keyword">const</span> templateDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>templateDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>templateDir<span class="token punctuation">,</span> appPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>到这里，<code>CRA</code> 的主流程就基本走完了，关于 <code>react-scripts</code> 的命令，比如 <code>start</code> 和 <code>build</code>，后续会单独有文章进行讲解。</p> <h2 id="_9-从-cra-中借鉴的工具方法"><a href="#_9-从-cra-中借鉴的工具方法" class="header-anchor">#</a> 9. 从 CRA 中借鉴的工具方法</h2> <p><code>CRA</code> 的代码和思路其实并不复杂，但是不影响我们读它的代码，并且从中学习到一些好的想法。（当然，有一些代码我们也是可以拿来直接用的 ~</p> <h3 id="_9-1-npm-相关"><a href="#_9-1-npm-相关" class="header-anchor">#</a> 9.1 npm 相关</h3> <h4 id="_9-1-1-获取-npm-包版本号"><a href="#_9-1-1-获取-npm-包版本号" class="header-anchor">#</a> 9.1.1 获取 npm 包版本号</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getDistTags</span><span class="token punctuation">(</span><span class="token parameter">pkgName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    https
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://registry.npmjs.org/-/package/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pkgName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist-tags</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>body <span class="token operator">+=</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取 react 的版本信息</span>
<span class="token function">getDistTags</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tags <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['latest', 'next', 'experimental', 'untagged']</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>latest<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 17.0.1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_9-1-2-比较-npm-包版本号"><a href="#_9-1-2-比较-npm-包版本号" class="header-anchor">#</a> 9.1.2 比较 npm 包版本号</h4> <p>使用 <code>semver</code> 包来判断某个 <code>npm</code> 的版本号是否符合你的要求：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> semver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'semver'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

semver<span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">'1.2.3'</span><span class="token punctuation">,</span> <span class="token string">'9.8.7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
semver<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token string">'1.2.3'</span><span class="token punctuation">,</span> <span class="token string">'9.8.7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
semver<span class="token punctuation">.</span><span class="token function">minVersion</span><span class="token punctuation">(</span><span class="token string">'&gt;=1.0.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '1.0.0'</span>
</code></pre></div><h4 id="_9-1-3-检查-npm-包名"><a href="#_9-1-3-检查-npm-包名" class="header-anchor">#</a> 9.1.3 检查 npm 包名</h4> <p>可以通过 <code>validate-npm-package-name</code> 来检查包名是否符合 <code>npm</code> 的命名规范。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> validateProjectName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'validate-npm-package-name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> validationResult <span class="token operator">=</span> <span class="token function">validateProjectName</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationResult<span class="token punctuation">.</span>validForNewPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'npm naming restrictions'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 输出不符合规范的 issue</span>
  <span class="token punctuation">[</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>validationResult<span class="token punctuation">.</span>errors <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>validationResult<span class="token punctuation">.</span>warnings <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对应的 <code>npm</code> 命名规范可以见：<a href="https://www.npmjs.com/package/validate-npm-package-name#naming-rules" title="Naming Rules" target="_blank" rel="noopener noreferrer">Naming Rules<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_9-2-git-相关"><a href="#_9-2-git-相关" class="header-anchor">#</a> 9.2 git 相关</h3> <h4 id="_9-2-1-判断本地目录是否是一个-git-仓库"><a href="#_9-2-1-判断本地目录是否是一个-git-仓库" class="header-anchor">#</a> 9.2.1 判断本地目录是否是一个 git 仓库</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> execSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>execSync<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isInGitRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git rev-parse --is-inside-work-tree'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token string">'ignore'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_9-2-2-git-init"><a href="#_9-2-2-git-init" class="header-anchor">#</a> 9.2.2 git init</h4> <p>脚手架初始化代码之后，正常的研发链路都希望能够将本地代码提交到 <code>git</code> 进行托管。在这之前，就需要先对本地目录进行 <code>init</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> execSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>execSync<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">tryGitInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git --version'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token string">'ignore'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInGitRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git init'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token string">'ignore'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Git repo not initialized'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_9-2-3-git-commit"><a href="#_9-2-3-git-commit" class="header-anchor">#</a> 9.2.3 git commit</h4> <p>对本地目录执行 <code>git commit</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">tryGitCommit</span><span class="token punctuation">(</span><span class="token parameter">appPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git add -A'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token string">'ignore'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git commit -m &quot;Initialize project using Create React App&quot;'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      stdio<span class="token operator">:</span> <span class="token string">'ignore'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We couldn't commit in already initialized git repo,</span>
    <span class="token comment">// maybe the commit author config is not set.</span>
    <span class="token comment">// In the future, we might supply our own committer</span>
    <span class="token comment">// like Ember CLI does, but for now, let's just</span>
    <span class="token comment">// remove the Git files to avoid a half-done state.</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Git commit not created'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Removing .git directory...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// unlinkSync() doesn't work on directories.</span>
      fs<span class="token punctuation">.</span><span class="token function">removeSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appPath<span class="token punctuation">,</span> <span class="token string">'.git'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>removeErr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Ignore.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10-总结"><a href="#_10-总结" class="header-anchor">#</a> 10. 总结</h2> <p>回到 <code>CRA</code>，看完本文，对于 <code>CRA</code> 的思想可能有了个大致了解：</p> <ol><li><code>CRA</code>  是一个通用的 <code>React</code>  脚手架，它支持自定义模板的初始化。将模板代码托管在 <code>npm</code>  上，而不是传统的通过 <code>git</code>  来托管模板代码，这样方便扩展和管理</li> <li><code>CRA</code>  只负责核心依赖、模板的安装和脚手架的核心功能，具体初始化代码的工作交给 <code>react-scripts</code>  这个包</li></ol> <p>但是具体细节上它是如何做的这个我没有详细的阐述，如果感兴趣的同学可以自行下载其源码阅读。推荐阅读源码流程：</p> <ol><li>看它的单测</li> <li>一步一步 debug 它</li> <li>看源码细节</li></ol> <p>个人原创技术文章会同步更新在公众号 <strong>玩相机的程序员</strong> 上，欢迎大家关注。我是 axuebin，用键盘和相机记录生活。</p> <div class="article-footer" data-v-4713b8bc><div role="separator" class="ant-divider ant-divider-horizontal" data-v-4713b8bc></div> <p data-v-4713b8bc>
    关注公众号
    <span class="bold" data-v-4713b8bc>玩相机的程序员</span></p> <p data-v-4713b8bc>原创文章持续更新中</p> <img src="/articles/assets/img/qrcode.jpg" data-v-4713b8bc> <p data-v-4713b8bc>我是 axuebin，用键盘和相机记录生活</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/articles/fe-solution/cli/desc.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        现代 CLI 和 GUI 方案指南
      </a></span> <span class="next"><a href="/articles/fe-solution/cli/vuecli.html">
        Vue CLI 是如何实现的 -- 终端命令行工具篇
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"><div class="right-group" data-v-63a47ae2><div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>关注微信公众号</div> <div class="desc" data-v-63a47ae2>高质量原创文章</div> <img src="/articles/assets/img/qrcode.jpg" alt="玩相机的程序员" title="玩相机的程序员" data-v-63a47ae2></div> <div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>加入前端划水群</div> <div class="desc" data-v-63a47ae2>
      扫码备注
      <span class="red" data-v-63a47ae2>加群</span></div> <img src="/articles/assets/img/wechat.jpg" alt="axuebin" title="axuebin" data-v-63a47ae2></div></div></div></div>
    <script src="/articles/assets/js/app.310f691c.js" defer></script><script src="/articles/assets/js/2.8d419c10.js" defer></script><script src="/articles/assets/js/19.60c3b1e2.js" defer></script><script src="/articles/assets/js/3.97f21fa0.js" defer></script><script src="/articles/assets/js/4.3f1e58e8.js" defer></script>
  </body>
</html>