<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>简单实现 babel-plugin-import 插件 | 玩相机的程序员</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="代码和照片本质都是创造，是一种信息的传递。我是玩相机的程序员 axuebin，用键盘和相机记录和分享。">
    <link rel="preload" href="/articles/assets/css/0.styles.fe65aa1c.css" as="style"><link rel="preload" href="/articles/assets/js/app.310f691c.js" as="script"><link rel="preload" href="/articles/assets/js/2.8d419c10.js" as="script"><link rel="preload" href="/articles/assets/js/16.4e7dfcad.js" as="script"><link rel="preload" href="/articles/assets/js/3.97f21fa0.js" as="script"><link rel="preload" href="/articles/assets/js/4.3f1e58e8.js" as="script"><link rel="prefetch" href="/articles/assets/js/10.4265f4ce.js"><link rel="prefetch" href="/articles/assets/js/11.76f5f86d.js"><link rel="prefetch" href="/articles/assets/js/12.893e4bb1.js"><link rel="prefetch" href="/articles/assets/js/13.98208f64.js"><link rel="prefetch" href="/articles/assets/js/14.7a017fd2.js"><link rel="prefetch" href="/articles/assets/js/15.3426649e.js"><link rel="prefetch" href="/articles/assets/js/17.ceed3886.js"><link rel="prefetch" href="/articles/assets/js/18.288adc60.js"><link rel="prefetch" href="/articles/assets/js/19.60c3b1e2.js"><link rel="prefetch" href="/articles/assets/js/20.9438fdb5.js"><link rel="prefetch" href="/articles/assets/js/21.35e5c2c6.js"><link rel="prefetch" href="/articles/assets/js/22.8f5f945f.js"><link rel="prefetch" href="/articles/assets/js/5.5f71be51.js"><link rel="prefetch" href="/articles/assets/js/6.f64c5fbd.js"><link rel="prefetch" href="/articles/assets/js/7.47f2d43a.js"><link rel="prefetch" href="/articles/assets/js/8.22fa8963.js"><link rel="prefetch" href="/articles/assets/js/9.16d00e35.js">
    <link rel="stylesheet" href="/articles/assets/css/0.styles.fe65aa1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/articles/" class="router-link-active home-link"><img src="/articles/assets/img/avatar.jpg" alt="玩相机的程序员" class="logo"> <span class="site-name">玩相机的程序员</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-solution/" class="router-link-active">
          前端工程化
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-interview/">
          前端面试
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          关注我
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <!----></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="ads"><div id="ads_2"><div class="ant-carousel"><div class="slick-slider slick-initialized"><div class="slick-list"><div class="slick-track"><div tabIndex="-1" data-index="0" class="slick-slide slick-active slick-current" style="outline:none;width:null;"><div><div tabIndex="-1" style="width:100%;display:inline-block;"><a target="_blank" rel="noopener noreferrer"><img src="/articles/assets/img/qrcode2.jpg" title="Ads details here"></a></div></div></div></div></div></div></div></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>脚手架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/cli/desc.html" title="现代 CLI 和 GUI 方案指南" class="sidebar-link">现代 CLI 和 GUI 方案指南</a></li><li><a href="/articles/fe-solution/cli/cra.html" title="create-react-app 核心思路分析" class="sidebar-link">create-react-app 核心思路分析</a></li><li><a href="/articles/fe-solution/cli/vuecli.html" title="Vue CLI 是如何实现的 -- 终端命令行工具篇" class="sidebar-link">Vue CLI 是如何实现的 -- 终端命令行工具篇</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Babel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/babel/first.html" title="初学 Babel 工作原理" class="sidebar-link">初学 Babel 工作原理</a></li><li><a href="/articles/fe-solution/babel/auto-require.html" title="如何用 Babel 为代码自动引入依赖" class="sidebar-link">如何用 Babel 为代码自动引入依赖</a></li><li><a href="/articles/fe-solution/babel/babel-plugin-import.html" aria-current="page" title="简单实现 babel-plugin-import 插件" class="active sidebar-link">简单实现 babel-plugin-import 插件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>构建相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/build/rax-analysis.html" title="当我谈 Rax 按端拆分代码的时候我谈些什么" class="sidebar-link">当我谈 Rax 按端拆分代码的时候我谈些什么</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码规范相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/lint/eslint.html" title="中小型前端团队代码规范工程化最佳实践 - ESLint" class="sidebar-link">中小型前端团队代码规范工程化最佳实践 - ESLint</a></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="简单实现-babel-plugin-import-插件"><a href="#简单实现-babel-plugin-import-插件" class="header-anchor">#</a> 简单实现 babel-plugin-import 插件</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>平时在使用 <code>antd</code>、<code>element</code> 等组件库的时候，都会使用到一个 <code>Babel</code> 插件：<code>babel-plugin-import</code>，这篇文章通过例子和分析源码简单说一下这个插件做了一些什么事情，并且实现一个最小可用版本。</p> <p>插件地址：<a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener noreferrer">https://github.com/ant-design/babel-plugin-import<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="babel-plugin-import-介绍"><a href="#babel-plugin-import-介绍" class="header-anchor">#</a> babel-plugin-import 介绍</h2> <h3 id="why-为什么需要这个插件"><a href="#why-为什么需要这个插件" class="header-anchor">#</a> Why：为什么需要这个插件</h3> <p><code>antd</code> 和 <code>element</code> 这两个组件库，看它的源码， <code>index.js</code> 分别是这样的：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// antd</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./button'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> Table <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./table'</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// element</span>
<span class="token keyword">import</span> Button <span class="token keyword">from</span> <span class="token string">'../packages/button/index.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Table <span class="token keyword">from</span> <span class="token string">'../packages/table/index.js'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  Button<span class="token punctuation">,</span>
  Table<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>antd</code> 和 <code>element</code> 都是通过 <code>ES6 Module</code> 的 <code>export</code> 来导出带有命名的各个组件。</p> <p>所以，我们可以通过 <code>ES6</code> 的 <code>import { } from</code> 的语法来导入单组件的 <code>JS</code> 文件。但是，我们还需要手动引入组件的样式：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// antd</span>
<span class="token keyword">import</span> <span class="token string">'antd/dist/antd.css'</span><span class="token punctuation">;</span>
<span class="token comment">// element</span>
<span class="token keyword">import</span> <span class="token string">'element-ui/lib/theme-chalk/index.css'</span><span class="token punctuation">;</span>
</code></pre></div><p>如果仅仅是只需要一个 <code>Button</code> 组件，却把所有的样式都引入了，这明显是不合理的。</p> <p>当然，你说也可以只使用单个组件啊，还可以减少代码体积：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> Button <span class="token keyword">from</span> <span class="token string">'antd/lib/button'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'antd/lib/button/style'</span><span class="token punctuation">;</span>
</code></pre></div><p>PS：类似 <code>antd</code> 的组件库提供了 <code>ES Module</code> 的构建产物，直接通过 <code>import {} from</code> 的形式也可以 <code>tree-shaking</code>，这个不在今天的话题之内，就不展开说了~</p> <p>对，这没毛病。但是，看一下如们需要多个组件的时候：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Affix<span class="token punctuation">,</span> Avatar<span class="token punctuation">,</span> Button<span class="token punctuation">,</span> Rate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'antd/lib/affix/style'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'antd/lib/avatar/style'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'antd/lib/button/style'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'antd/lib/rate/style'</span><span class="token punctuation">;</span>
</code></pre></div><p>会不会觉得这样的代码不够优雅？如果是我，甚至想打人。</p> <p>这时候就应该思考一下，如何在引入 <code>Button</code> 的时候自动引入它的样式文件。</p> <h3 id="what-这个插件做了什么"><a href="#what-这个插件做了什么" class="header-anchor">#</a> What：这个插件做了什么</h3> <p>简单来说，<code>babel-plugin-import</code> 就是解决了上面的问题，为组件库实现单组件按需加载并且自动引入其样式，如：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

      ↓ ↓ ↓ ↓ ↓ ↓

<span class="token keyword">var</span> _button <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/button/style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>只需关心需要引入哪些组件即可，内部样式我并不需要关心，你帮我自动引入就 ok。</p> <h3 id="how-这个插件怎么用"><a href="#how-这个插件怎么用" class="header-anchor">#</a> How：这个插件怎么用</h3> <p>简单来说就需要关心三个参数即可：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;libraryName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;antd&quot;</span><span class="token punctuation">,</span>     <span class="token comment">// 包名</span>
  <span class="token string">&quot;libraryDirectory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 目录，默认 lib</span>
  <span class="token string">&quot;style&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// 是否引入 style</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其它的看文档：<a href="https://github.com/ant-design/babel-plugin-import#usage" target="_blank" rel="noopener noreferrer">https://github.com/ant-design/babel-plugin-import#usage<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="babel-plugin-import-源码分析"><a href="#babel-plugin-import-源码分析" class="header-anchor">#</a> babel-plugin-import 源码分析</h2> <p>主要来看一下 <code>babel-plugin-import</code> 如何加载 <code>JavaScript</code> 代码和样式的。</p> <p>以下面这段代码为例：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button<span class="token punctuation">,</span> Rate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">xxxx</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="第一步-依赖收集"><a href="#第一步-依赖收集" class="header-anchor">#</a> 第一步 依赖收集</h3> <p><code>babel-plubin-import</code> 会在 <code>ImportDeclaration</code> 里将所有的 <code>specifier</code> 收集起来。</p> <p>先看一下 <code>ast</code> 吧：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/549a822bb38a4250bf884965d1bf6811~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以从这个 <code>ImportDeclaration</code> 语句中提取几个关键点：</p> <ul><li>source.value: antd</li> <li>specifier.local.name: Button</li> <li>specifier.local.name: Rate</li></ul> <p>需要做的事情也很简单：</p> <ol><li><code>import</code> 的包是不是 <code>antd</code>，也就是 <code>libraryName</code></li> <li>把 <code>Button</code> 和 <code>Rate</code> 收集起来</li></ol> <p>来看代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// 代码里 import 的包名</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
  <span class="token comment">// 配在插件 options 的包名</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// babel-type 工具函数</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> types <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 内部状态</span>
  <span class="token keyword">const</span> pluginState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPluginState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是不是需要使用该插件的包</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> libraryName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// node.specifiers 表示 import 了什么</span>
    node<span class="token punctuation">.</span>specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">spec</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断是不是 ImportSpecifier 类型的节点，也就是是否是大括号的</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">isImportSpecifier</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 收集依赖</span>
        <span class="token comment">// 也就是 pluginState.specified.Button = Button</span>
        <span class="token comment">// local.name 是导入进来的别名，比如 import { Button as MyButton } from 'antd' 的 MyButton</span>
        <span class="token comment">// imported.name 是真实导出的变量名</span>
        pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>spec<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> spec<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ImportDefaultSpecifier 和 ImportNamespaceSpecifier</span>
        pluginState<span class="token punctuation">.</span>libraryObjs<span class="token punctuation">[</span>spec<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pluginState<span class="token punctuation">.</span>pathsToRemove<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>待 <code>babel</code> 遍历了所有的 <code>ImportDeclaration</code> 类型的节点之后，就收集好了依赖关系，下一步就是如何加载它们了。</p> <h3 id="第二步-判断是否使用"><a href="#第二步-判断是否使用" class="header-anchor">#</a> 第二步 判断是否使用</h3> <p>收集了依赖关系之后，得要判断一下这些 <code>import</code> 的变量是否被使用到了，我们这里说一种情况。</p> <p>我们知道，<code>JSX</code> 最终是变成 <code>React.createElement()</code> 执行的：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Hello</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ↓ ↓ ↓ ↓ ↓ ↓

React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Button<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>没错，<code>createElement</code> 的第一个参数就是我们要找的东西，我们需要判断收集的依赖中是否有被 <code>createElement</code> 使用。</p> <p>分析一下这行代码的 <code>ast</code>，很容易就找到这个节点：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90b6003025574a2e98f4342fcbbe2e1a~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>来看代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token punctuation">(</span>path <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span>hub <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span>hub<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 方法调用者的 name</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>callee<span class="token punctuation">;</span>
  <span class="token comment">// babel-type 工具函数</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> types <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 内部状态</span>
  <span class="token keyword">const</span> pluginState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPluginState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果方法调用者是 Identifier 类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>callee <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">importMethod</span><span class="token punctuation">(</span>pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> pluginState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 遍历 arguments 找我们要的 specifier</span>
  node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> argName <span class="token punctuation">}</span> <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>argName<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">hasBinding</span><span class="token punctuation">(</span>argName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>argName<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportSpecifier'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 找到 specifier，调用 importMethod 方法</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">importMethod</span><span class="token punctuation">(</span>pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>argName<span class="token punctuation">]</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> pluginState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> arg<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了 <code>React.createElement(Button)</code> 之外，还有 <code>const btn = Button</code> / <code>[Button]</code> ... 等多种情况会使用 <code>Button</code>，源码中都有对应的处理方法，感兴趣的可以自己看一下： <a href="https://github.com/ant-design/babel-plugin-import/blob/master/src/Plugin.js#L163-L272" target="_blank" rel="noopener noreferrer">https://github.com/ant-design/babel-plugin-import/blob/master/src/Plugin.js#L163-L272<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，这里就不多说了。</p> <h3 id="第三步-生成引入代码-核心"><a href="#第三步-生成引入代码-核心" class="header-anchor">#</a> 第三步 生成引入代码（核心）</h3> <p>第一步和第二步主要的工作是找到需要被插件处理的依赖关系，比如：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button<span class="token punctuation">,</span> Rate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Hello</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Button</code> 组件使用到了，<code>Rate</code> 在代码里未使用。所以插件要做的也只是自动引入 <code>Button</code> 的代码和样式即可。</p> <p>我们先回顾一下，当我们 <code>import</code> 一个组件的时候，希望它能够：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

      ↓ ↓ ↓ ↓ ↓ ↓

<span class="token keyword">var</span> _button <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/button/style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>并且再回想一下插件的配置 <a href="https://github.com/ant-design/babel-plugin-import#options" target="_blank" rel="noopener noreferrer">options<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，只需要将 <code>libraryDirectory</code> 以及 <code>style</code> 等配置用上就完事了。</p> <p>小朋友，你是否有几个问号？这里该如何让 <code>babel</code> 去修改代码并且生成一个新的 <code>import</code> 以及一个样式的 <code>import</code> 呢，不慌，看看代码就知道了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> addSideEffect<span class="token punctuation">,</span> addDefault<span class="token punctuation">,</span> addNamed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@babel/helper-module-imports'</span><span class="token punctuation">;</span>

<span class="token function">importMethod</span><span class="token punctuation">(</span><span class="token parameter">methodName<span class="token punctuation">,</span> file<span class="token punctuation">,</span> pluginState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pluginState<span class="token punctuation">.</span>selectedMethods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// libraryDirectory：目录，默认 lib</span>
    <span class="token comment">// style：是否引入样式</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> style<span class="token punctuation">,</span> libraryDirectory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// 组件名转换规则</span>
    <span class="token comment">// 优先级最高的是配了 camel2UnderlineComponentName：是否使用下划线作为连接符</span>
    <span class="token comment">// camel2DashComponentName 为 true，会转换成小写字母，并且使用 - 作为连接符</span>
    <span class="token keyword">const</span> transformedMethodName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>camel2UnderlineComponentName
      <span class="token operator">?</span> <span class="token function">transCamel</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>camel2DashComponentName
      <span class="token operator">?</span> <span class="token function">transCamel</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> methodName<span class="token punctuation">;</span>
    <span class="token comment">// 兼容 windows 路径</span>
    <span class="token comment">// path.join('antd/lib/button') == 'antd/lib/button'</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">winPath</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>customName
        <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">customName</span><span class="token punctuation">(</span>transformedMethodName<span class="token punctuation">,</span> file<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>libraryName<span class="token punctuation">,</span> libraryDirectory<span class="token punctuation">,</span> transformedMethodName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据是否有导出 default 来判断使用哪种方法来生成 import 语句，默认为 true</span>
    <span class="token comment">// addDefault(path, 'antd/lib/button', { nameHint: 'button' })</span>
    <span class="token comment">// addNamed(path, 'button', 'antd/lib/button')</span>
    pluginState<span class="token punctuation">.</span>selectedMethods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transformToDefaultImport
      <span class="token operator">?</span> <span class="token function">addDefault</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token punctuation">{</span> nameHint<span class="token operator">:</span> methodName <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">addNamed</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据不同配置 import 样式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>customStyleName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> stylePath <span class="token operator">=</span> <span class="token function">winPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">customStyleName</span><span class="token punctuation">(</span>transformedMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">addSideEffect</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stylePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>styleLibraryDirectory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> stylePath <span class="token operator">=</span> <span class="token function">winPath</span><span class="token punctuation">(</span>
        <span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>libraryName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>styleLibraryDirectory<span class="token punctuation">,</span> transformedMethodName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">addSideEffect</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stylePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>style <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addSideEffect</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/style</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>style <span class="token operator">===</span> <span class="token string">'css'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addSideEffect</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/style/css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> style <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> stylePath <span class="token operator">=</span> <span class="token function">style</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stylePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addSideEffect</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> stylePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pluginState<span class="token punctuation">.</span>selectedMethods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>addSideEffect</code>, <code>addDefault</code> 和 <code>addNamed</code> 是 <code>@babel/helper-module-imports</code> 的三个方法，作用都是创建一个 <code>import</code> 方法，具体表现是：</p> <h4 id="addsideeffect"><a href="#addsideeffect" class="header-anchor">#</a> addSideEffect</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addSideEffect</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'source'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ↓ ↓ ↓ ↓ ↓ ↓

<span class="token keyword">import</span> <span class="token string">&quot;source&quot;</span>
</code></pre></div><h4 id="adddefault"><a href="#adddefault" class="header-anchor">#</a> addDefault</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addDefault</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'source'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> nameHint<span class="token operator">:</span> <span class="token string">&quot;hintedName&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

      ↓ ↓ ↓ ↓ ↓ ↓

<span class="token keyword">import</span> hintedName <span class="token keyword">from</span> <span class="token string">&quot;source&quot;</span>
</code></pre></div><h4 id="addnamed"><a href="#addnamed" class="header-anchor">#</a> addNamed</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addNamed</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'named'</span><span class="token punctuation">,</span> <span class="token string">'source'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> nameHint<span class="token operator">:</span> <span class="token string">&quot;hintedName&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ↓ ↓ ↓ ↓ ↓ ↓

<span class="token keyword">import</span> <span class="token punctuation">{</span> named <span class="token keyword">as</span> _hintedName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;source&quot;</span>
</code></pre></div><p>更多关于 <code>@babel/helper-module-imports</code> 见：<a href="https://babeljs.io/docs/en/next/babel-helper-module-imports.html" target="_blank" rel="noopener noreferrer">@babel/helper-module-imports<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>一起数个 1 2 3，<code>babel-plugin-import</code> 要做的事情也就做完了。</p> <p>我们来总结一下，<code>babel-plugin-import</code> 和普遍的 <code>babel</code> 插件一样，会遍历代码的 <code>ast</code>，然后在 <code>ast</code> 上做了一些事情：</p> <ol><li><strong>收集依赖</strong>：找到 <code>importDeclaration</code>，分析出包 <code>a</code> 和依赖 <code>b,c,d....</code>，假如 <code>a</code> 和 <code>libraryName</code> 一致，就将 <code>b,c,d...</code> 在内部收集起来</li> <li><strong>判断是否使用</strong>：在多种情况下（比如文中提到的 <code>CallExpression</code>）判断 收集到的 <code>b,c,d...</code> 是否在代码中被使用，如果有使用的，就调用 <code>importMethod</code> 生成新的 <code>impport</code> 语句</li> <li><strong>生成引入代码</strong>：根据配置项生成代码和样式的 <code>import</code> 语句</li></ol> <p>不过有一些细节这里就没提到，比如如何删除旧的 <code>import</code> 等... 感兴趣的可以自行阅读源码哦。</p> <p>看完一遍源码，是不是有发现，其实除了 <code>antd</code> 和 <code>element</code> 等大型组件库之外，任意的组件库都可以使用 <code>babel-plugin-import</code> 来实现按需加载和自动加载样式。</p> <p>没错，比如我们常用的 <code>lodash</code>，也可以使用 <code>babel-plugin-import</code> 来加载它的各种方法，可以动手试一下。</p> <h2 id="动手实现-babel-plugin-import"><a href="#动手实现-babel-plugin-import" class="header-anchor">#</a> 动手实现 babel-plugin-import</h2> <p>看了这么多，自己动手实现一个简易版的 <code>babel-plugin-import</code> 吧。</p> <p>如果还不了解如何实现一个 <code>Babel</code> 插件，可以阅读 <a href="https://juejin.cn/post/6905707252963868679" target="_blank" rel="noopener noreferrer">【Babel 插件入门】如何用 Babel 为代码自动引入依赖
<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="最简功能实现"><a href="#最简功能实现" class="header-anchor">#</a> 最简功能实现</h3> <p>按照上文说的，最重要的配置项就是三个：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;libraryName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;antd&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;libraryDirectory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;style&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以我们也就只实现这三个配置项。</p> <p>并且，上文提到，真实情况中会有多种方式来调用一个组件，这里我们也不处理这些复杂情况，只实现最常见的 <code>&lt;Button /&gt;</code> 调用。</p> <h3 id="入口文件"><a href="#入口文件" class="header-anchor">#</a> 入口文件</h3> <p>入口文件的作用是获取用户传入的配置项并且将核心插件代码作用到 <code>ast</code> 上。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Plugin <span class="token keyword">from</span> <span class="token string">'./Plugin'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> plugins <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 将插件作用到节点上</span>
  <span class="token keyword">function</span> <span class="token function">applyInstance</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        plugin<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>args<span class="token punctuation">,</span> context<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> Program <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ast 入口</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> <span class="token punctuation">{</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 初始化插件实例</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
          <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span>
            opts<span class="token punctuation">.</span>libraryName<span class="token punctuation">,</span>
            opts<span class="token punctuation">.</span>libraryDirectory<span class="token punctuation">,</span>
            opts<span class="token punctuation">.</span>style<span class="token punctuation">,</span>
            types
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">applyInstance</span><span class="token punctuation">(</span><span class="token string">'ProgramEnter'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ast 出口</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">applyInstance</span><span class="token punctuation">(</span><span class="token string">'ProgramExit'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span> Program <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 插件只作用在 ImportDeclaration 和 CallExpression 上</span>
  <span class="token punctuation">[</span><span class="token string">'ImportDeclaration'</span><span class="token punctuation">,</span> <span class="token string">'CallExpression'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ret<span class="token punctuation">.</span>visitor<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">applyInstance</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> arguments<span class="token punctuation">,</span> ret<span class="token punctuation">.</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="核心代码"><a href="#核心代码" class="header-anchor">#</a> 核心代码</h3> <p>真正修改 <code>ast</code> 的代码是在 <code>plugin</code> 实现的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> addSideEffect<span class="token punctuation">,</span> addDefault <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@babel/helper-module-imports'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 转换成小写，添加连接符
 * @param {*} _str   字符串
 * @param {*} symbol 连接符
 */</span>
<span class="token keyword">function</span> <span class="token function">transCamel</span><span class="token punctuation">(</span><span class="token parameter">_str<span class="token punctuation">,</span> symbol</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> str <span class="token operator">=</span> _str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> _str<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([A-Z])</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token parameter">$<span class="token number">1</span></span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>symbol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">1.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 兼容 Windows 路径
 * @param {*} path
 */</span>
<span class="token keyword">function</span> <span class="token function">winPath</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    libraryName<span class="token punctuation">,</span> <span class="token comment">// 需要使用按需加载的包名</span>
    libraryDirectory <span class="token operator">=</span> <span class="token string">'lib'</span><span class="token punctuation">,</span> <span class="token comment">// 按需加载的目录</span>
    style <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是否加载样式</span>
    types <span class="token comment">// babel-type 工具函数</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>libraryName <span class="token operator">=</span> libraryName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>libraryDirectory <span class="token operator">=</span> libraryDirectory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>style <span class="token operator">=</span> style<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>types <span class="token operator">=</span> types<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 获取内部状态，收集依赖
   * @param {*} state
   */</span>
  <span class="token function">getPluginState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 生成 import 语句（核心代码）
   * @param {*} methodName
   * @param {*} file
   * @param {*} pluginState
   */</span>
  <span class="token function">importMethod</span><span class="token punctuation">(</span><span class="token parameter">methodName<span class="token punctuation">,</span> file<span class="token punctuation">,</span> pluginState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pluginState<span class="token punctuation">.</span>selectedMethods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// libraryDirectory：目录，默认 lib</span>
      <span class="token comment">// style：是否引入样式</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> style<span class="token punctuation">,</span> libraryDirectory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token comment">// 组件名转换规则</span>
      <span class="token keyword">const</span> transformedMethodName <span class="token operator">=</span> <span class="token function">transCamel</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 兼容 windows 路径</span>
      <span class="token comment">// path.join('antd/lib/button') == 'antd/lib/button'</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">winPath</span><span class="token punctuation">(</span>
        <span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>libraryName<span class="token punctuation">,</span> libraryDirectory<span class="token punctuation">,</span> transformedMethodName<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 生成 import 语句</span>
      <span class="token comment">// import Button from 'antd/lib/button'</span>
      pluginState<span class="token punctuation">.</span>selectedMethods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">addDefault</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        nameHint<span class="token operator">:</span> methodName<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 生成样式 import 语句</span>
        <span class="token comment">// import 'antd/lib/button/style'</span>
        <span class="token function">addSideEffect</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/style</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pluginState<span class="token punctuation">.</span>selectedMethods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">ProgramEnter</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pluginState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPluginState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pluginState<span class="token punctuation">.</span>specified <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pluginState<span class="token punctuation">.</span>selectedMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pluginState<span class="token punctuation">.</span>pathsToRemove <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">ProgramExit</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 删除旧的 import</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPluginState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span>pathsToRemove<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
      <span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>removed <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * ImportDeclaration 节点的处理方法
   * @param {*} path
   * @param {*} state
   */</span>
  <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// 代码里 import 的包名</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
    <span class="token comment">// 配在插件 options 的包名</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// babel-type 工具函数</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> types <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 内部状态</span>
    <span class="token keyword">const</span> pluginState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPluginState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断是不是需要使用该插件的包</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> libraryName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// node.specifiers 表示 import 了什么</span>
      node<span class="token punctuation">.</span>specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">spec</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断是不是 ImportSpecifier 类型的节点，也就是是否是大括号的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">isImportSpecifier</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 收集依赖</span>
          <span class="token comment">// 也就是 pluginState.specified.Button = Button</span>
          <span class="token comment">// local.name 是导入进来的别名，比如 import { Button as MyButton } from 'antd' 的 MyButton</span>
          <span class="token comment">// imported.name 是真实导出的变量名</span>
          pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>spec<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> spec<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// ImportDefaultSpecifier 和 ImportNamespaceSpecifier</span>
          pluginState<span class="token punctuation">.</span>libraryObjs<span class="token punctuation">[</span>spec<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 收集旧的依赖</span>
      pluginState<span class="token punctuation">.</span>pathsToRemove<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * React.createElement 对应的节点处理方法
   * @param {*} path
   * @param {*} state
   */</span>
  <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token punctuation">(</span>path <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span>hub <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span>hub<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 方法调用者的 name</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>callee<span class="token punctuation">;</span>
    <span class="token comment">// babel-type 工具函数</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> types <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 内部状态</span>
    <span class="token keyword">const</span> pluginState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPluginState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果方法调用者是 Identifier 类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>callee <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">importMethod</span><span class="token punctuation">(</span>
          pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span>
          file<span class="token punctuation">,</span>
          pluginState
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 遍历 arguments 找我们要的 specifier</span>
    node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> argName <span class="token punctuation">}</span> <span class="token operator">=</span> arg<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>argName<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">hasBinding</span><span class="token punctuation">(</span>argName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>argName<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportSpecifier'</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 找到 specifier，调用 importMethod 方法</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">importMethod</span><span class="token punctuation">(</span>
          pluginState<span class="token punctuation">.</span>specified<span class="token punctuation">[</span>argName<span class="token punctuation">]</span><span class="token punctuation">,</span>
          file<span class="token punctuation">,</span>
          pluginState
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> arg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就实现了一个最简单的 <code>babel-plugin-import</code> 插件，可以自动加载单包和样式。</p> <p>完整代码：<a href="https://github.com/axuebin/babel-plugin-import-demo" target="_blank" rel="noopener noreferrer">https://github.com/axuebin/babel-plugin-import-demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h2> <p>本文通过源码解析和动手实践，深入浅出的介绍了 <code>babel-plugin-import</code> 插件的原理，希望大家看完这篇文章之后，都能清楚地了解这个插件做了什么事。</p> <p>更多文章可以关注公众号「前端试炼」，分享每日前端精选文章。</p> <p>关于 <code>Babel</code> 你会用到的一些链接：</p> <ul><li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/user-handbook.md" target="_blank" rel="noopener noreferrer">Babel 用户手册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md" target="_blank" rel="noopener noreferrer">Babel 插件手册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">ast 分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/estree/estree" target="_blank" rel="noopener noreferrer">节点规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="article-footer" data-v-4713b8bc><div role="separator" class="ant-divider ant-divider-horizontal" data-v-4713b8bc></div> <p data-v-4713b8bc>
    关注公众号
    <span class="bold" data-v-4713b8bc>玩相机的程序员</span></p> <p data-v-4713b8bc>原创文章持续更新中</p> <img src="/articles/assets/img/qrcode.jpg" data-v-4713b8bc> <p data-v-4713b8bc>我是 axuebin，用键盘和相机记录生活</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/articles/fe-solution/babel/auto-require.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        如何用 Babel 为代码自动引入依赖
      </a></span> <span class="next"><a href="/articles/fe-solution/build/rax-analysis.html">
        当我谈 Rax 按端拆分代码的时候我谈些什么
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"><div class="right-group" data-v-63a47ae2><div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>关注微信公众号</div> <div class="desc" data-v-63a47ae2>高质量原创文章</div> <img src="/articles/assets/img/qrcode.jpg" alt="玩相机的程序员" title="玩相机的程序员" data-v-63a47ae2></div> <div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>加入前端划水群</div> <div class="desc" data-v-63a47ae2>
      扫码备注
      <span class="red" data-v-63a47ae2>加群</span></div> <img src="/articles/assets/img/wechat.jpg" alt="axuebin" title="axuebin" data-v-63a47ae2></div></div></div></div>
    <script src="/articles/assets/js/app.310f691c.js" defer></script><script src="/articles/assets/js/2.8d419c10.js" defer></script><script src="/articles/assets/js/16.4e7dfcad.js" defer></script><script src="/articles/assets/js/3.97f21fa0.js" defer></script><script src="/articles/assets/js/4.3f1e58e8.js" defer></script>
  </body>
</html>